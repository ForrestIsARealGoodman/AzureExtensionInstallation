---
- name: Gather list of target machines
  azure.azcollection.azure_rm_virtualmachine_info:
    subscription_id: "{{ subscription_id }}"
    resource_group: "WEM-CUSTOMERS-RG-1"
    name: "customer-09d3nu1yo5x1-console-cloud124build6222"
  register: search_results

- debug:
    var: search_results

- name: Fail if search_results yields nothing
  fail:
    msg: "No results"
  when: search_results.vms | length == 0

- name: Create list of all targeted servers based on filters above
  set_fact:
    target_machines: "{{ search_results.vms }}"

- debug:
    msg: "os type: {{ item.os_type }} - id: {{ item.image.id }}  "
  with_items: '{{ target_machines }}'